{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Eloutfit{% endblock %}

{% block content %}
<!-- Mobile-Optimized Cart Page -->
<div class="cart-page">
    <div class="container">
        <!-- Header -->
        <div class="cart-header">
            <h1 class="page-title">Shopping Cart</h1>
            {% if cart.items.count > 0 %}
            <div class="cart-stats">
                <span class="item-count">{{ cart.total_quantity }} item{{ cart.total_quantity|pluralize }}</span>
            </div>
            {% endif %}
        </div>

        {% if cart.items.count > 0 %}
        <!-- Cart Items -->
        <div class="cart-items-section">
            {% for item in cart.items.all %}
            <div class="cart-item-card" data-item-id="{{ item.id }}">
                <div class="item-image">
                    {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" loading="lazy">
                    {% else %}
                    <img src="{% static 'images/placeholder.jpg' %}" alt="No image" loading="lazy">
                    {% endif %}
                </div>
                
                <div class="item-details">
                    <div class="item-header">
                        <h3 class="product-name">
                            <a href="{{ item.product.get_absolute_url }}">{{ item.product.name }}</a>
                        </h3>
                        <a href="{% url 'cart:remove_from_cart' item.id %}" class="remove-btn" 
                           onclick="return confirm('Remove this item from cart?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                    
                    <div class="product-category">
                        {{ item.product.category.name }}
                    </div>
                    
                    <div class="stock-status">
                        {% if item.product.available and item.product.stock > 0 %}
                            {% if item.product.stock < 10 %}
                            <span class="low-stock">
                                <i class="fas fa-exclamation-triangle"></i>
                                Only {{ item.product.stock }} left!
                            </span>
                            {% else %}
                            <span class="in-stock">
                                <i class="fas fa-check-circle"></i>
                                In Stock
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="out-of-stock">
                            <i class="fas fa-times-circle"></i>
                            Out of Stock
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="price-section">
                        <div class="unit-price">₹{{ item.product.price }}</div>
                        <div class="total-price">₹{{ item.total_price }}</div>
                    </div>
                    
                    <div class="quantity-controls">
                        <form action="{% url 'cart:update_cart' item.id %}" method="post" class="quantity-form" data-max-stock="{{ item.product.stock }}">
                            {% csrf_token %}
                            <div class="quantity-selector">
                                <button type="button" class="qty-btn minus" data-action="decrease">-</button>
                                <input type="number" name="quantity" value="{{ item.quantity }}" 
                                       min="1" max="{{ item.product.stock }}" class="qty-input" 
                                       data-item-id="{{ item.id }}" data-current-stock="{{ item.product.stock }}">
                                <button type="button" class="qty-btn plus" data-action="increase">+</button>
                            </div>
                            <button type="submit" class="update-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Stock validation message -->
                    <div class="stock-message" id="stock-message-{{ item.id }}" style="display: none;">
                        <span class="stock-error"></span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Validation Messages -->
        <div class="cart-alerts">
            {% for item in cart.items.all %}
                {% if item.quantity > item.product.stock %}
                <div class="alert alert-warning stock-alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>"{{ item.product.name }}"</strong> only has {{ item.product.stock }} item(s) in stock. 
                    Your quantity has been adjusted.
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Action Buttons -->
        <div class="cart-actions-mobile">
            <a href="{% url 'product_list' %}" class="btn-continue-shopping">
                <i class="fas fa-arrow-left"></i>
                Continue Shopping
            </a>
            <a href="{% url 'cart:clear_cart' %}" class="btn-clear-cart"
               onclick="return confirm('Are you sure you want to clear your entire cart?')">
                <i class="fas fa-trash"></i>
                Clear Cart
            </a>
        </div>

        <!-- Order Summary - Sticky on Mobile -->
        <div class="order-summary-sticky">
            <div class="summary-content">
                <h3 class="summary-title">Order Summary</h3>
                
                <div class="summary-details">
                    <div class="summary-row">
                        <span>Subtotal ({{ cart.total_quantity }} items)</span>
                        <span>₹{{ cart.total_price }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span class="free-shipping">FREE</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax</span>
                        <span>₹0.00</span>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-row total-row">
                        <strong>Total</strong>
                        <strong>₹{{ cart.total_price }}</strong>
                    </div>
                </div>

                <!-- Checkout validation -->
                <div class="checkout-validation">
                    {% for item in cart.items.all %}
                        {% if item.quantity > item.product.stock or not item.product.available %}
                        <div class="checkout-error">
                            <i class="fas fa-exclamation-circle"></i>
                            Please update your cart before checkout
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <a href="{% url 'checkout' %}" class="btn-checkout {% if not cart.is_valid %}btn-checkout-disabled{% endif %}" 
                   {% if not cart.is_valid %}onclick="return false;" style="opacity: 0.6; cursor: not-allowed;"{% endif %}>
                    <i class="fas fa-credit-card"></i>
                    {% if cart.is_valid %}
                    Proceed to Checkout
                    {% else %}
                    Update Cart to Checkout
                    {% endif %}
                </a>
                
                <div class="shipping-note">
                    <i class="fas fa-shipping-fast"></i>
                    Free shipping on all orders
                </div>
            </div>
        </div>

        {% else %}
        <!-- Empty Cart State -->
        <div class="empty-cart-state">
            <div class="empty-cart-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h2>Your cart is empty</h2>
            <p class="empty-cart-message">
                Looks like you haven't added any items to your cart yet.
            </p>
            <a href="{% url 'product_list' %}" class="btn-start-shopping">
                <i class="fas fa-bag-shopping"></i>
                Start Shopping
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Add these new styles for stock validation */

.stock-alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 12px 15px;
    margin: 10px 0;
    font-size: 0.9rem;
}

.stock-alert i {
    color: #ffc107;
    margin-right: 8px;
}

.low-stock {
    color: #ff9800;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.out-of-stock {
    color: #dc3545;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stock-message {
    margin-top: 8px;
    padding: 8px;
    border-radius: 4px;
    font-size: 0.8rem;
}

.stock-error {
    color: #dc3545;
    display: flex;
    align-items: center;
    gap: 5px;
}

.checkout-validation {
    margin-bottom: 10px;
}

.checkout-error {
    background: #f8d7da;
    color: #721c24;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-checkout-disabled {
    background: #6c757d !important;
    cursor: not-allowed !important;
}

.btn-checkout-disabled:hover {
    background: #6c757d !important;
    transform: none !important;
}

/* Quantity input styles for invalid states */
.qty-input:invalid {
    border: 1px solid #dc3545;
    background: #f8d7da;
}

.quantity-selector.invalid {
    border-color: #dc3545;
}

/* Alert animations */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.5s ease-in-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quantity controls with stock validation
    const quantityForms = document.querySelectorAll('.quantity-form');
    
    quantityForms.forEach(form => {
        const minusBtn = form.querySelector('.minus');
        const plusBtn = form.querySelector('.plus');
        const qtyInput = form.querySelector('.qty-input');
        const updateBtn = form.querySelector('.update-btn');
        const maxStock = parseInt(form.dataset.maxStock);
        const itemId = qtyInput.dataset.itemId;
        const stockMessage = document.getElementById(`stock-message-${itemId}`);
        
        let currentValue = parseInt(qtyInput.value);
        
        function validateQuantity(quantity) {
            if (quantity > maxStock) {
                showStockError(`Only ${maxStock} items available`);
                return false;
            }
            if (quantity < 1) {
                showStockError('Quantity must be at least 1');
                return false;
            }
            hideStockError();
            return true;
        }
        
        function showStockError(message) {
            stockMessage.style.display = 'block';
            stockMessage.querySelector('.stock-error').innerHTML = 
                `<i class="fas fa-exclamation-circle"></i>${message}`;
            form.classList.add('invalid');
            qtyInput.classList.add('invalid');
        }
        
        function hideStockError() {
            stockMessage.style.display = 'none';
            form.classList.remove('invalid');
            qtyInput.classList.remove('invalid');
        }
        
        function updateQuantity(newValue) {
            if (validateQuantity(newValue)) {
                currentValue = newValue;
                qtyInput.value = currentValue;
                highlightUpdate();
            }
        }
        
        // Decrease quantity
        minusBtn.addEventListener('click', function() {
            if (currentValue > 1) {
                updateQuantity(currentValue - 1);
            }
        });
        
        // Increase quantity
        plusBtn.addEventListener('click', function() {
            if (currentValue < maxStock) {
                updateQuantity(currentValue + 1);
            } else {
                showStockError(`Maximum ${maxStock} items available`);
            }
        });
        
        // Input change
        qtyInput.addEventListener('change', function() {
            let value = parseInt(this.value);
            if (isNaN(value) || value < 1) {
                value = 1;
            }
            updateQuantity(value);
        });
        
        // Input blur - auto update if valid
        qtyInput.addEventListener('blur', function() {
            if (validateQuantity(currentValue)) {
                // Auto-submit the form if quantity is valid
                setTimeout(() => {
                    form.submit();
                }, 500);
            }
        });
        
        // Form submission validation
        form.addEventListener('submit', function(e) {
            if (!validateQuantity(currentValue)) {
                e.preventDefault();
                form.classList.add('shake');
                setTimeout(() => {
                    form.classList.remove('shake');
                }, 500);
            }
        });
        
        function highlightUpdate() {
            updateBtn.style.background = '#28a745';
            setTimeout(() => {
                updateBtn.style.background = '#007bff';
            }, 300);
        }
        
        // Initial validation
        validateQuantity(currentValue);
    });
    
    // Check if any items exceed stock on page load
    function validateCartOnLoad() {
        let hasStockIssues = false;
        quantityForms.forEach(form => {
            const qtyInput = form.querySelector('.qty-input');
            const maxStock = parseInt(form.dataset.maxStock);
            const currentValue = parseInt(qtyInput.value);
            
            if (currentValue > maxStock) {
                hasStockIssues = true;
                // Auto-correct the quantity to max available
                qtyInput.value = maxStock;
                // Show message and suggest update
                const itemId = qtyInput.dataset.itemId;
                const stockMessage = document.getElementById(`stock-message-${itemId}`);
                showStockMessage(stockMessage, `Quantity adjusted to maximum available (${maxStock})`);
            }
        });
        
        return !hasStockIssues;
    }
    
    function showStockMessage(element, message) {
        element.style.display = 'block';
        element.querySelector('.stock-error').innerHTML = 
            `<i class="fas fa-info-circle"></i>${message}`;
        element.style.background = '#d1ecf1';
        element.querySelector('.stock-error').style.color = '#0c5460';
    }
    
    // Run validation on page load
    validateCartOnLoad();
});
</script>
{% endblock %}