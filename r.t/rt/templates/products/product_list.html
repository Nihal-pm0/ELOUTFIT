{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if category %}{{ category.name }}{% else %}All Products{% endif %} - Eloutfit
{% endblock %}

{% block content %}
<section class="product-store padding-large">
  <div class="container">
    <div class="row">
      <!-- Sidebar - Hidden on mobile -->
      <div class="col-lg-3 col-md-4 d-none d-md-block">
        <div class="sidebar sticky-sidebar">
          <h4 class="text-uppercase mb-4">Categories</h4>
          <ul class="list-unstyled">
            <li class="mb-2">
              <a href="{% url 'product_list' %}" class="{% if not category %}fw-bold text-dark{% endif %}">
                All Products
              </a>
            </li>
            {% for cat in categories %}
            <li class="mb-2">
              <a href="{% url 'product_list_by_category' cat.slug %}"
                class="{% if category and category.slug == cat.slug %}fw-bold text-dark{% endif %}">
                {{ cat.name }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Products -->
      <div class="col-lg-9 col-md-8">
        <!-- Mobile Category Filter -->
        <div class="d-md-none mb-4">
          <select class="form-select" onchange="location = this.value;">
            <option value="{% url 'product_list' %}">All Categories</option>
            {% for cat in categories %}
            <option value="{% url 'product_list_by_category' cat.slug %}" {% if category and category.slug==cat.slug
              %}selected{% endif %}>
              {{ cat.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div
          class="display-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center pb-3">
          <h2 class="display-7 text-dark text-uppercase mb-3 mb-md-0">
            {% if category %}{{ category.name }}{% else %}All Products{% endif %}
            <span class="text-muted fs-6 d-block d-md-inline ms-md-2">({{ products.paginator.count }} products)</span>
          </h2>
          <div class="sorting">
            <select class="form-select" onchange="location = this.value;">
              <option value="?sort=newest" {% if sort=='newest' %}selected{% endif %}>Newest First</option>
              <option value="?sort=price_low" {% if sort=='price_low' %}selected{% endif %}>Price: Low to High</option>
              <option value="?sort=price_high" {% if sort=='price_high' %}selected{% endif %}>Price: High to Low
              </option>
            </select>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="row">
          {% for product in products %}
          <div class="col-xl-3 col-lg-4 col-sm-6 col-6 mb-4">
            <div class="product-card position-relative h-100">
              <div class="image-holder position-relative">
                <a href="{{ product.get_absolute_url }}" class="d-block product-image-link">
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid product-image">
                </a>

                {% if not product.available %}
                <div class="position-absolute top-0 start-0 m-2">
                  <span class="badge bg-secondary">Out of Stock</span>
                </div>
                {% endif %}
              </div>

              <div class="card-detail pt-3">
                <h4 class="card-title text-uppercase mb-1">
                  <a href="{{ product.get_absolute_url }}" class="text-decoration-none text-dark product-name">
                    {{ product.name }}
                  </a>
                </h4>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="item-price text-primary fw-bold">â‚¹{{ product.price }}</span>
                  {% if product.available %}
                  <a href="{% url 'cart:add_to_cart' product.id %}"
                    class="btn btn-dark btn-sm add-to-cart-btn text-nowrap w-25">
                    Add to Cart
                  </a>
                  {% else %}
                  <button class="btn btn-secondary btn-sm" disabled style="min-width: 100px;">Out of Stock</button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <i class="bi bi-box display-4 text-muted mb-3"></i>
              <h4 class="mb-2">No products found</h4>
              <p class="text-muted mb-4">Try browsing other categories or check back later for new products.</p>
              <a href="{% url 'product_list' %}" class="btn btn-dark">Browse All Products</a>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-5">
          <ul class="pagination justify-content-center flex-wrap">
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if sort %}&sort={{ sort }}{% endif %}">{{ num }}</a>
              </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if sort %}&sort={{ sort }}{% endif %}">
                Next <i class="bi bi-chevron-right"></i>
              </a>
            </li>
            {% endif %}
              {% endfor %}

              {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                  href="?page={{ page_obj.next_page_number }}{% if sort %}&sort={{ sort }}{% endif %}">
                  Next <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<style>
  /* Product Card Styles */
  .product-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  /* Consistent Image Sizing */
  .product-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }

  .product-image-link:hover .product-image {
    transform: scale(1.05);
  }

  /* Product Name */
  .product-name {
    font-size: 0.95rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.6em;
  }

  /* Card Detail */
  .card-detail {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  /* Sticky Sidebar */
  .sticky-sidebar {
    position: sticky;
    top: 20px;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .product-store {
      padding: 1rem 0;
    }

    .product-card {
      padding: 12px;
      margin-bottom: 1rem;
    }

    .product-image {
      height: 200px;
    }

    .product-name {
      font-size: 0.9rem;
    }

    .display-7 {
      font-size: 1.5rem;
    }

    .pagination .page-link {
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 576px) {
    .product-image {
      height: 180px;
    }

    .product-card {
      padding: 10px;
    }

    .col-6 {
      padding-left: 5px;
      padding-right: 5px;
    }

    .product-name {
      font-size: 0.85rem;
    }

    .item-price {
      font-size: 0.9rem;
    }
  }

  @media (max-width: 400px) {
    .product-image {
      height: 160px;
    }

    .product-card {
      padding: 8px;
    }
  }

  /* Empty State */
  .empty-state {
    padding: 3rem 1rem;
  }

  /* Pagination responsive */
  .pagination {
    flex-wrap: wrap;
  }

  .page-item {
    margin: 2px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Make entire product card clickable on mobile
    if (window.innerWidth < 768) {
      const productCards = document.querySelectorAll('.product-card');
      productCards.forEach(card => {
        const productLink = card.querySelector('.product-image-link');
        card.style.cursor = 'pointer';
        card.addEventListener('click', function (e) {
          // Don't trigger if clicked on buttons or links
          if (!e.target.closest('a') && !e.target.closest('button')) {
            productLink.click();
          }
        });
      });
    }

    // Add loading state for images
    const productImages = document.querySelectorAll('.product-image');
    productImages.forEach(img => {
      img.addEventListener('load', function () {
        this.style.opacity = '1';
      });
      img.style.opacity = '0';
      img.style.transition = 'opacity 0.3s ease';

      // If image is already loaded
      if (img.complete) {
        img.style.opacity = '1';
      }
    });
  });
</script>
{% endblock %}